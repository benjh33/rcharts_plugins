<!DOCTYPE html>
<html lang='en'>
<head>
<!--    <script src="js/jquery-ui-1.10.4.custom/js/jquery-ui-1.10.4.custom.min.js
" charset="utf-8"></script>    
-->
    <script src='js/jquery-1.8.2.min.js' type='text/javascript'></script>
    <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
    <script src="js/d3.v3.min.js" charset="utf-8"></script>
    <script src='js/lodash.js' type='text/javascript'></script>
    <script src='bootstrap3/js/bootstrap.min.js' type='text/javascript'></script>
    <script src='js/colorbrewer.v1.min.js' type='text/javascript'></script>
    <script src="js/missing-data.js" charset="utf-8"></script>
    <script src="js/crossfilter.js" charset="utf-8"></script>
    <script src="js/box.js" charset="utf-8"></script>
    <script src="js/scatter_crossfilter.js" charset="utf-8"></script>    
    <link rel="stylesheet" type="text/css" href="bootstrap3/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/themes/smoothness/jquery-ui.css" />
<!--     <link rel="stylesheet" type="text/css" href="js/jquery-ui-1.10.4.custom/css/ui-lightness/jquery-ui-1.10.4.custom.min.css
">
 -->
<script>
$.getScript('http://davidstutz.github.io/bootstrap-multiselect/js/bootstrap-multiselect.js',function(){
  
  $('.single option').click(function() {
    // only affects options contained within the same optgroup
    // and doesn't include this
    //$(this).siblings().prop('selected', false);
  });
  
});
</script>
</head>
<body>
<div class='container'>
  <div class='row'>
    <div class="col-md-3 well" id='controls'>
    </div>
    <div class="col-md-9 chart" id="chart">
    </div>
  </div>
</div>
<script>
d3.csv('data/beauty.csv', function(error, dat) {

// column_types for beauty.csv
  var dtypes = {
  "tenured": "factor",
  "profnumber": "factor",
  "minority": "factor",
  "age": "integer",
  "beautyf2upper": "integer",
  "beautyflowerdiv": "integer",
  "beautyfupperdiv": "integer",
  "beautym2upper": "integer",
  "beautymlowerdiv": "integer",
  "beautymupperdiv": "integer",
  "btystdave": "numeric",
  "btystdf2u": "numeric",
  "btystdfl": "numeric",
  "btystdfu": "numeric",
  "btystdm2u": "numeric",
  "btystdml": "numeric",
  "btystdmu": "numeric",
  "class1": "factor",
  "class2": "factor",
  "class3": "factor",
  "class4": "factor",
  "class5": "factor",
  "class6": "factor",
  "class7": "factor",
  "class8": "factor",
  "class9": "factor",
  "class10": "factor",
  "class11": "factor",
  "class12": "factor",
  "class13": "factor",
  "class14": "factor",
  "class15": "factor",
  "class16": "factor",
  "class17": "factor",
  "class18": "factor",
  "class19": "factor",
  "class20": "factor",
  "class21": "factor",
  "class22": "factor",
  "class23": "factor",
  "class24": "factor",
  "class25": "factor",
  "class26": "factor",
  "class27": "factor",
  "class28": "factor",
  "class29": "factor",
  "class30": "factor",
  "courseevaluation": "numeric",
  "didevaluation": "integer",
  "female": "factor",
  "formal": "factor",
  "fulldept": "factor",
  "lower": "factor",
  "multipleclass": "factor",
  "nonenglish": "factor",
  "onecredit": "factor",
  "percentevaluating": "numeric",
  "profevaluation": "numeric",
  "students": "integer",
  "tenuretrack": "factor",
  "blkandwhite": "factor",
  "btystdvariance": "numeric",
  "btystdavepos": "numeric",
  "btystdaveneg": "numeric" 
  }
// end dtypes


  var width = 600,
      height = 600, 
      xvar = 'Estimate',
      yvar = 'variable',
      error = 'Std. Error',
      padding = {
         "top":    40,
         "right":  30,
         "bottom": 60,
         "left":   70
      },
      size = {
        "x":  width - padding.left - padding.right,
        "y": height - padding.top  - padding.bottom
      }, 
      refitting = false,
      function transition_time() {return refitting ? 0:1000}

      function tooltip_content(d) {
        return "<p>" + xvar + ": " + d[xvar] + "<br>" + 
              error + ": " + d[error] + '<br>'
      }

      var tooltip = d3.select('#chart').append('text')
                  .attr('class', 'tooltip')
                  .attr('id', 'hist_tooltip')
                  .style('opacity', 0),

      sel = d3.select("#chart").append('svg')
                  .attr('class', 'hist_frame')
                  .attr('width', width)
                  .attr('height', height),

      g = sel.append('g')
              .attr('id', 'hist_chart')
              .attr('transform', 'translate(' + padding.left + ',' +
                    padding.top + ")"),


      x = d3.scale.linear()
                  .range([0, size.x])
                  .domain(d3.extent(_.map(data, 
                          function(d) { 
                            return d[xvar] > 0 ? 
                            d[xvar] + d[error] * 2:
                            d[xvar] - d[error] * 2;}))),

      y = d3.scale.linear()
                  .range([0, size.y])
                  .domain(d3.extent(group.all())),

      xax = d3.svg.axis()
              .scale(x)
              .orient('bottom')
              .ticks(10)
              .tickSize(-size.y),

      yax = d3.svg.axis()
              .scale(y)
              .orient('left')
              .tickSize(-size.x);

      g.append('g')
        .attr('class', 'hist_xaxis')
        .attr('transform', 'translate(0, ' + size.y + ')')

      g.append('g').attr('class', ' hist_yaxis')

      g.append('rect')
        .attr("class", 'background')
        .attr('pointer-events', 'all')
        .attr('fill', 'none')
        .attr('height', size.y)
        .attr("width", size.x)

      g.append('svg')
        .attr('class', 'bars')
        .attr('top', 0)
        .attr('left', 0)
        .attr('width', size.x + 'px')
        .attr('height', size.y + 'px')
        .attr('viewBox', "0 0 " + size.x + " " + size.y)

        function draw_bars() {

          g.select('.coef_xaxis')
              .call(xax)
              .selectAll('text')
              .attr('dy', '1.5em')
              .attr('text-anchor', 'middle')

          g.select('.coef_yaxis')
              .call(yax)
              .selectAll('text')
              .attr('x', x(0))
              .attr('dy', '1em')
              .attr('text-anchor', 'middle');

          var bars = g.select('.bars').selectAll('.bar')
                   .data(data)
          bars.transition().duration(transition_time())
              .each(function(bar) {
               d3.select(this).select('rect.est')
               .style('opacity', 0.6)
               .attr('x', function(d) {
                return x(Math.min(0, d[xvar]));})
               .attr('width', function(d) { 
                return Math.abs(x(d[xvar]) - x(0))})
               d3.select(this).select('path.error')
                 .attr('d', function(d) { return errorBarArea([d]) })
               })
          bars.enter().append('g')
             .attr('class', 'bar')
             .each(function(bar) {
              b = d3.select(this)
                 .append('rect')
              b.attr('class', 'est')
                 .style('opacity', 0.1)
                 .attr('x', function(d) {
                  return x(0);})
                 .attr('width', 0)
                 .attr('height', y.rangeBand())
                 .transition().duration(transition_time())
                 .style('fill', function(d) { return d[xvar] > 0 ? pos:neg})
                 .style('opacity', 0.6)
                 .attr('x', function(d) {
                  return x(Math.min(0, d[xvar]));})
                 .attr('width', function(d) { 
                  return Math.abs(x(d[xvar]) - x(0))})
                 .attr('y', function(d) { return y(d[yvar]); })
                 .attr('height', y.rangeBand())
              b.on('mouseover', function(d) {
                  d3.select(this).style('opacity', 0.9);
                    tooltip.transition()
                      .duration(200)
                      .style('opacity', 0.9)
                    tooltip.html(function() { return tooltip_content(d)})
                        .style('left', (d3.mouse(this)[0] +390 + 'px'))
                        .style('top', (d3.mouse(this)[1] -20 + 'px'))
                     })
                  .on('mousemove', function(d) {
                    tooltip.html(function() { return tooltip_content(d)})
                        .style('left', (d3.mouse(this)[0] + 30 + 'px'))
                        .style('top', (d3.mouse(this)[1] -20 + 'px'))
                      })
                  .on('mouseout', function(d) {
                    d3.select(this).style('opacity', 0.6);
                    tooltip.transition().duration(200).style('opacity', 0)
                    })

              errors = d3.select(this)
                        .append('path')
                        .attr('class', 'error')
                        .style('opacity', 0.1)
                        .style('stroke-width', 5)
                        .attr('d', function(d) {
                          var tmp = {};
                          tmp[error] = 0;
                          tmp[xvar] = 0;
                          tmp[yvar] = d[yvar];
                          return errorBarArea([tmp])})
                       .transition().duration(transition_time())
                       .attr('d', function(d) { return errorBarArea([d]) })
                       .style('stroke', 'black')
                       .style('stroke-width', 5)
                       .style('opacity', 0.8)

             });

          bars.exit().transition().duration(transition_time()).remove() 
          g.select(".background").call(d3.behavior.zoom().x(x).on("zoom", refit));
        }
        // draw_bars()

        function refit() {
          refitting = true;
          draw_bars();
          refitting = false;
        }

});
// var coeficient = d3.barchart_errors()
//                   .width(300)
//                   .height(600)


</script>
</body>
</html>
