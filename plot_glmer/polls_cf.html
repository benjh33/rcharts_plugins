<!DOCTYPE html>
<html lang='en'>
<head>
<!--    <script src="js/jquery-ui-1.10.4.custom/js/jquery-ui-1.10.4.custom.min.js
" charset="utf-8"></script>    
-->
    <script src='js/jquery-1.8.2.min.js' type='text/javascript'></script>
    <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>

    <script src='js/lodash.js' type='text/javascript'></script>
    <script src='bootstrap3/js/bootstrap.min.js' type='text/javascript'></script>
    <script src="js/bootstrap-multiselect.js" charset="utf-8"></script>    

    <script src="js/d3.v3.min.js" charset="utf-8"></script>
    <script src='js/colorbrewer.v1.min.js' type='text/javascript'></script>
    <script src="js/crossfilter.js" charset="utf-8"></script>
    <script src="js/box.js" charset="utf-8"></script>
    <script src="js/scatter_lm.js" charset="utf-8"></script>    
    <script src="js/coefficients.js" charset="utf-8"></script>    
    <script src="js/hist_cf.js" charset="utf-8"></script>    

    <link rel="stylesheet" type="text/css" href="bootstrap3/css/bootstrap.min.css">
    <link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/themes/smoothness/jquery-ui.css" />
    <link rel="stylesheet" href="css/bootstrap-multiselect.css" type="text/css"/>
    <link rel="stylesheet" type="text/css" href="css/style.css">
  </head>
<body>
<div class='container' style='width:1800px'>
  <div class='row'>
    <div class="col-md-3 well" id='controls' style='width:300px'>
    </div>
    <div class="row">
      <div class="col-md-9" id="chart">
      </div>
    </div>
  </div>
</div>
<script>

d3.csv('data/polls.csv', function(error, dat) {

// column_types for beauty.csv
  var dtypes = {
  "org": "factor",
  "year": "factor",
  "survey": "factor",
  "bush": "factor",
  "state": "factor",
  "edu": "factor",
  "age": "factor",
  "female": "factor",
  "black": "factor",
  "weight": "numeric",
  "fit_m1": "numeric",
  "fit_m2": "numeric",
  "fit_m3": "numeric",
  "resid_m1": "numeric",
  "resid_m2": "numeric",
  "resid_m3": "numeric",
  "fit_m1": "numeric",
  "fit_m2": "numeric",
  "fit_m3": "numeric",
  "resid_m1": "numeric",
  "resid_m2": "numeric",
  "resid_m3": "numeric",
  "fit_m1": "numeric",
  "fit_m2": "numeric",
  "fit_m3": "numeric",
  "resid_m1": "numeric",
  "resid_m2": "numeric",
  "resid_m3": "numeric" 
 }
// end dtypes

// coefficients
var coefs = {
 "m1": {
 "Estimate": [ 0.42956, -1.6499, -0.11243 ],
"Std. Error": [ 0.02956, 0.083879, 0.038708 ],
"z value": [ 14.532, -19.669, -2.9046 ],
"Pr(>|z|)": [ 7.6172e-48, 3.9474e-86, 0.0036768 ],
"variable": [ "(Intercept)", "black1", "female1" ] 
},
"m2": {
 "Estimate": [ 0.2739, -1.6708, -0.1153, 0.32509, 0.42803, 0.27621, -0.17992, -0.19652, -0.17651 ],
"Std. Error": [ 0.074923, 0.08452, 0.039001, 0.067744, 0.071637, 0.070755, 0.052363, 0.056017, 0.064754 ],
"z value": [ 3.6557, -19.768, -2.9563, 4.7988,  5.975, 3.9037, -3.436, -3.5083, -2.7258 ],
"Pr(>|z|)": [ 0.00025648, 5.5909e-87, 0.0031139, 1.5958e-06, 2.3011e-09, 9.4748e-05, 0.00059042, 0.00045102, 0.0064143 ],
"variable": [ "(Intercept)", "black1", "female1", "edu2", "edu3", "edu4", "age2", "age3", "age4" ] 
},
"m3": {
 "Estimate": [ 0.22738, -1.6741, -0.11584, 0.32408, 0.43205, 0.27762, -0.18036, -0.19492, -0.17771, 0.026928, -0.014881, 0.031237, 0.14001, 0.076743, 0.030028 ],
"Std. Error": [ 0.089694, 0.084568, 0.039022, 0.067774, 0.071738, 0.070795, 0.052387, 0.056098, 0.064872, 0.07706, 0.076374, 0.076778, 0.072229, 0.071264, 0.070763 ],
"z value": [ 2.5351, -19.796, -2.9686, 4.7818, 6.0226, 3.9215, -3.4429, -3.4747, -2.7394, 0.34945, -0.19484, 0.40685, 1.9384, 1.0769, 0.42435 ],
"Pr(>|z|)": [ 0.011241, 3.2129e-87, 0.0029916, 1.7374e-06, 1.7161e-09, 8.8006e-05, 0.00057549, 0.00051144, 0.0061557, 0.72675, 0.84552, 0.68412, 0.052571, 0.28153, 0.67131 ],
"variable": [ "(Intercept)", "black1", "female1", "edu2", "edu3", "edu4", "age2", "age3", "age4", "year2", "year3", "year4", "year5", "year6", "year7" ] 
} 
},
formulas = {
 "m1": "bush ~ black + female",
"m2": "bush ~ black + female + edu + age",
"m3": "bush ~ black + female + edu + age + year" 
}
// function to zip model output into row format with variable names
// as keys


function coefsObj(coefs, model) {
  m = coefs[model]
  return _.zipObject(_.map(m, 
                  function(d) { return d.variable;}), m)
}
// changes above json output from R into row-based object for each
// model
coefs = _.forOwn(coefs, function(v, k, o) {
  var keys = _.keys(v)
  o[k] = _.map(_.range(v['Estimate'].length), function(x) {
    return _.zipObject(keys, _.map(keys, function(t) {
        return v[t][x];
      }))
  })
})
// end coefficents

// get numeric variables in array
var numeric = _.filter(_.keys(dtypes), function(d) { 
  return _.contains(['numeric', 'integer'], dtypes[d]) ;}),
// reset to only look for two data types, numeric and factor
dtypes =  _.zipObject(_.keys(dtypes), _.map(_.keys(dtypes), 
  function(d) { 
    return _.contains(['integer', 'numeric'], 
                      dtypes[d]) ? 'numeric': 'factor'}))
// get factor variables in array
var factor = _.filter(_.keys(dtypes), function(d) { 
  return dtypes[d] == 'factor'}),
// prepare crossfilter and set up some parameters
data = crossfilter(dat),
yvar = 'bush',
xvar = 'age',
sc_width = 700,
sc_height = 700,
color_var = factor[0],
filter_var = factor[2],
model = _.keys(coefs)[2],
size_var = numeric[3],
colors = d3.scale.category10();

dat.forEach(function(d, i) {
  d._index = i;
  _.map(_.keys(d), function(k) {
    if('numeric' == dtypes[k]){
      d[k] = +d[k]; 
    }
  })
})

// adding switches
var labels = ['choose_x', 'choose_y', 'choose_color',
                      'choose_size', 'choose_filter'],
buttons = d3.select('#controls').append('div')
            .attr('class', 'btn-group-vertical sc')

buttons.selectAll('div')
        .data(['choose_model'])
        .enter().append('div')
        .attr('class', 'models')
        .each(function(d, i) {
          d3.select(this).append('label')
              .attr('for', d)
              .text(d.replace(/choose_/, '') + ':')
          d3.select(this).append('select')
            .attr('class', 'btn selectpicker controls')
            .attr("id", d)
            .each(function(button) {
              d3.select(this).select('#' + button)
                .append('span').attr('class', 'caret')
              d3.select(this).selectAll('option')
                .data(_.keys(coefs))
                .enter().append('option')
                .text(function(t) { return t;})
                .attr('selected', function(d,i) { 
                  return _.keys(coefs)[i] == model ? "selected":null})
            })

        })

buttons = buttons.selectAll('div.variables')
      .data(labels)
      .enter().append('div')
      .attr('class', 'variables')
      .each(function(d,i) {
        d3.select(this).append('label')
              .attr('for', d)
              .text(d.replace(/choose_/, '') + ':')
       var select = d3.select(this).append('select')
        select.attr('class','btn selectpicker controls')
        .attr('data-width', 'auto')
        .attr('id', function(d) { return d;})
        .each(function(button) {
        d3.select(this).select("#" + button)
          .append('span').attr('class', 'caret')
        button = d3.select(this).selectAll('option')
              .data(_.keys(dtypes).filter(function(d,k) { 
                if(i == 2) return true
                else if (i == 4) return _.contains(factor, d)
                else if (_.contains(numeric.concat(factor), d)) 
                    return true;
              }))
            .enter().append('option')
              .text(function(d) { return d;})
              .attr('selected', function(d) {
                if(i == 0) { return d == xvar ? 'selected': null}
                  else if(i == 1) { return d == yvar ? 'selected': null}
                  else if(i == 2) { return d== color_var ? 'selected': null}
                  else if(i == 3) { return d==size_var ? 'selected':null}
                  else if(i == 4) { return d==filter_var ? 'selected':null}
              })
      })
    })

d3.select('#choose_filter').on('change', function() {
  filter_var = this.value;
  fil.dispose();
  fil = data.dimension(function(d) { return d[filter_var]})
  update_filter();
  update_all();
});
d3.select('#choose_x').on('change', function() {
  xvar = this.value
  update_all();
});
d3.select('#choose_y').on('change', function() {
  yvar = this.value
  update_all();
});
d3.select('#choose_model').on('change', function() {
  model = this.value
  var coef_plot = d3.barchart_errors()
                .width(600)
                .formula(formulas[model])
  d3.select('#coefficients')
    .datum(coefs[model]).call(coef_plot)
  update_all();
});
d3.select('#choose_size').on('change', function() {
  size_var = this.value
  update_all();
});
d3.select('#choose_color').on('change', function() {
  color_var = this.value;
  update_color();
  update_all();
});

// should the filter be given discrete values or a range?
function fil_choices() {
  if("numeric" == dtypes[filter_var]) {
    return expand_extent(d3.extent(_.map($('#current_filter')[0].options,
      function(d) { if(d.selected) return parseFloat(d.value) })))
  } else {
    return _.map($('#current_filter')[0].options, 
        function(d) { if(d.selected) return d.value
    })
  }
}

// reset filter
function set_filter() {
  fil.filterAll();
  var items = fil_choices();
  if(_.contains(['numeric', 'integer'], dtypes[filter_var])) {
    fil.filterRange([d3.min(items), d3.max(items)])
  } else {
    fil.filterFunction(function(d) { 
      return items.indexOf(d) > -1;
    })
  }
  all_hist = _.map(_.range(0, numeric.length), function(d) {
      return {vname: numeric[d], dim: inx};})

  hist_div.selectAll('div.hist')
    .data(all_hist, function(d) { return d.vname})
    .each(function() {
      d3.select(this)
        .call(ch);
    });
};

// setting up crossfilters
var data = crossfilter(dat),
inx = data.dimension(function(d) { return d._index; }),
fil = data.dimension(function(d) { return d[filter_var];});

// update filters
function update_filter() {
  fil.dispose();
  fil = data.dimension(function(d) { return d[filter_var];});
  d3.select('#current_filter').remove()
  d3.select('.btn-group').remove()
  d3.select('.btn-group-vertical .filter_group').remove()
  var cur_filter = d3.select('.btn-group-vertical.sc')
                  .append('div')
                  .attr('class', 'filter_group')
                  .append('select')
                  .attr('id', 'current_filter')
                  .attr('multiple', 'multiple')
                  .attr('class', 'controls')
      cur_filter.selectAll('option')
          .data(_.unique(_.map(fil.top(Infinity), function(d) {
            return d[filter_var];
            })))
         .enter().append('option')
          .attr('value', function(d) { return d;})
          .attr('selected', 'selected')
          .text(function(d) { return d;})
        $('#current_filter').multiselect({
          buttonWidth:false,
          includeSelectAllDivider: true,
          includeSelectAllOption: true}).on('change', 
            function() {set_filter(); update_all(); });
        d3.select("#current_filter~.btn-group")
          .insert('label', '.btn')
          .text(filter_var + ":")
        d3.select('#current_filter~.btn-group .btn')
          .style('border-radius', '4px')
}

function update_color() {
  // add continuous color scale for numeric color vars
  colors.domain(_.unique(_.map(inx.top(Infinity),
    function(d) { return d[color_var]})))
  // var w = sc_width - 220
  // var color_legend = d3.select('#color-legend')
  //                     .style('width', w)

  // function make_color_legend(el) { 
  //   el.append('text')
  //       .attr('text-anchor', 'right')
  //       .text(el[0][0].__data__)
  //   el.append('rect')
  //       .attr('width', 20)
  //       .attr('height', 20)
  //       .attr('x', 15)
  //       .attr('y', 20)
  //       .attr('fill', colors(el[0][0].__data__))
  //       .attr('fill-opacity', 0.8)
  // }

  // color_legend.select('#legend-name')
  //       .transition().duration(500)
  //       .style('opacity', 0)
  //       .transition().duration(500)
  //       .style('opacity', 1)
  //       .text(color_var + ":")
  //       .attr('x', 0)
  //       .attr('y', 10)

  // color_legend = color_legend.selectAll('div')
  //       .data(colors.domain())

  // color_legend.each(function(d, i) {
  //   var g = d3.select(this)
  //   g.select('rect').remove()
  //   g.select("text").remove()
  //   g.attr('transform', 'translate(0,' + (i * 25) + ')')
  //   g.call(make_color_legend)});

  // color_legend
  //    .enter().append('g')
  //     .attr('class', 'c')
  //     .each(function(d, i) {
  //       var g = d3.select(this)
  //       g.attr('transform', 'translate(0,' + (i * 25) + ')')
  //       g.call(make_color_legend)});

  // color_legend.exit()
  //   .transition().duration(1000)
  //   .style('opacity', 0).remove()
}

// getting factor and numeric terms for univariate charts.
function prep_formula(f) {
  var formula = f.replace(/ /g, ''),
  dep_var = formula.slice(0, formula.search(/~/)),
  indeps = formula.slice(formula.search(/~/) + 1).split('+')
  numeric_terms = _.filter(indeps, 
                           function(d) { return dtypes[d] == 'numeric'})
  return formula;
}

var scatter_div = d3.select('#chart')
      .append('div')
      .attr('id', 'scatter')
      .style('float','left')
      .style('width', '700px')
      .style('height', '700px')
      .datum([0])
// scatter_div.append('div')
//       .attr('id', 'color-legend')
//       .style('float', 'right')
//       .append('div')
//       .attr('id', 'legend-name')

var coef_div = d3.select('#chart').append('div');
coef_div
    .style('position', 'relative')
    .attr('id', 'coefficients')
    .style('float','left')
    .style('height', 700)
    .datum(coefs[model])

coef_plot = d3.barchart_errors()
              .width(600)
              .formula(formulas[model])

coef_div.call(coef_plot)

// histograms
function update_hist() {

  if(d3.select("#hist_select").empty()){
    var hist_select = d3.select('.btn-group-vertical.sc')
                    .append('div')
                    .attr('class', 'hist')
                    .append('select')
                    .attr('id', 'hist_select')
                    .attr('multiple', 'multiple')
                    .attr('class', 'controls')
    hist_select.selectAll('option')
      .data(numeric)
      .enter().append('option')
      .attr('value', function(d) { return d; })
      .attr('selected', function(d, i) {
        return i < 4 ? 'selected':null;
      })
      .text(function(d) { return d;})

    $('#hist_select').multiselect({
      onChange: function(option, checked) {
        // Get selected options.
        var selectedOptions = $('#hist_select option:selected');
 
        if (selectedOptions.length >= 4) {
          // Disable all other checkboxes.
          var nonSelectedOptions = $('#hist_select option').filter(function() {
            return !$(this).is(':selected');
          });
 
          var dropdown = $('#hist_select').siblings('.multiselect-container');
          nonSelectedOptions.each(function() {
            var input = $('input[value="' + $(this).val() + '"]');
            input.prop('disabled', true);
            input.parent('li').addClass('disabled');
          });
        }
        else {
          // Enable all checkboxes.
          var dropdown = $('#hist_select').siblings('.multiselect-container');
          $('#hist_select option').each(function() {
            var input = $('input[value="' + $(this).val() + '"]');
            input.prop('disabled', false);
            input.parent('li').addClass('disabled');
          });
        }
        add_hist();
      },
      buttonWidth:false})
    d3.select("#hist_select~.btn-group")
      .insert('label', '.btn')
      .text("histograms:")
    d3.select('#hist_select~.btn-group .btn')
      .style('border-radius', '4px')
  } else {
    var hist_select = d3.select('#hist_select')
  }
}


var hist_div = d3.select('#chart').append('div')
                .attr('class', 'row')
                .append('div')
                .attr('class', 'col-md-12')
                .style('float', 'left')
                .append('div')
                .attr('id', 'histograms')
                .attr('class', 'row'),
hist_width = 300;


var ch = d3.hist_cf()
          .color(colorbrewer.Dark2[5][1])
          .height(250)
          .width(hist_width)
          .tickdiv(5)
          .bins(30)

var order = numeric.slice(0,4)
function add_hist() {
  var choices = _.map($('#hist_select option:selected'), 
                      function(o) { return o.value;})

  if(choices.length != 4) {return null}else{
    var new_vars = _.difference(choices, order),
    remove = _.difference(order, choices),
    index = 0;

    for(var i = 0; i < remove.length; i++){
      order[order.indexOf(remove[i])] = new_vars[i];
    }

    var all_hist = _.map(order, function(d, i) {
          return {vname: d, dim: inx, index:i};})

    var hists = hist_div.selectAll('div.hist')
            .data(all_hist)

    hists.each(function(d, i) {
      var sel = d3.select(this)
      if(_.contains(new_vars, d.vname)){
        sel.call(ch)
      }
    })

    if(hists.empty()){
      hists.enter().insert('div')
        .attr('id', function(d) { return d.vname})
        .attr('class', function(d) { return 'hist'})
        .style('float', 'left')
        .style('position', 'relative')
        .each(function(d, i) {
          d3.select(this).call(ch)
        })
    }
  }
}

update_filter();
update_color();
update_hist();
add_hist();

function update_all() {


  scatter = d3.scatter_lm()
    .height(sc_height)
    .width(sc_width)
    .dimension(inx)
    .xvar(xvar)
    .yvar(yvar)
    .size_var(size_var)
    .color_var(color_var)
    .color_scale(colors)
    .filter_var(filter_var)
    .coefs(coefsObj(coefs, model))
    .dtypes(dtypes)
    .formula(prep_formula(formulas[model]))
    .npredictlines(3)
    .id('scatter');

  scatter_div.call(scatter)

}
update_all();

});
function iqr(k) {
return function(d, i) {
  var q1 = d.quartiles[0],
      q3 = d.quartiles[2],
      iqr = (q3 - q1) * k,
      i = -1,
      j = d.length;
  while (d[++i] < q1 - iqr);
  while (d[--j] > q3 + iqr);
  return [i, j];
};
}
function boxQuartiles(d) {
return [
  d3.quantile(d, .25),
  d3.quantile(d, .5),
  d3.quantile(d, .75)
];
}

// column_types for beauty.csv
  var dtypes = {
  "tenured": "factor",
  "profnumber": "factor",
  "minority": "factor",
  "age": "integer",
  "beautyf2upper": "integer",
  "beautyflowerdiv": "integer",
  "beautyfupperdiv": "integer",
  "beautym2upper": "integer",
  "beautymlowerdiv": "integer",
  "beautymupperdiv": "integer",
  "btystdave": "numeric",
  "btystdf2u": "numeric",
  "btystdfl": "numeric",
  "btystdfu": "numeric",
  "btystdm2u": "numeric",
  "btystdml": "numeric",
  "btystdmu": "numeric",
  "class1": "factor",
  "class2": "factor",
  "class3": "factor",
  "class4": "factor",
  "class5": "factor",
  "class6": "factor",
  "class7": "factor",
  "class8": "factor",
  "class9": "factor",
  "class10": "factor",
  "class11": "factor",
  "class12": "factor",
  "class13": "factor",
  "class14": "factor",
  "class15": "factor",
  "class16": "factor",
  "class17": "factor",
  "class18": "factor",
  "class19": "factor",
  "class20": "factor",
  "class21": "factor",
  "class22": "factor",
  "class23": "factor",
  "class24": "factor",
  "class25": "factor",
  "class26": "factor",
  "class27": "factor",
  "class28": "factor",
  "class29": "factor",
  "class30": "factor",
  "courseevaluation": "numeric",
  "didevaluation": "integer",
  "female": "factor",
  "formal": "factor",
  "fulldept": "factor",
  "lower": "factor",
  "multipleclass": "factor",
  "nonenglish": "factor",
  "onecredit": "factor",
  "percentevaluating": "numeric",
  "profevaluation": "numeric",
  "students": "integer",
  "tenuretrack": "factor",
  "blkandwhite": "factor",
  "btystdvariance": "numeric",
  "btystdavepos": "numeric",
  "btystdaveneg": "numeric" 
  }

 _.forOwn(dtypes, function(v,k) {
        if (_.contains(['integer', 'numeric'], v)) return dtypes[k] = 'numeric';
        if (_.contains(['character', 'factor'], v)) return dtypes[k] = 'factor';
      })
// end dtypes
</script>
</body>
</html>